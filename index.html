<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>The Rolodex From Hades [Demo Version]</title>
<style>
  :root {
    --bg: #2c0f1a;
    --card-bg: #111;
    --border: #444;
    --accent: #fff;
    --accent-hover: #d9c1cf;
    --text: #f5f5f5;
    --muted: #a78b9c;
    --radius: 14px;

    --result-font: 1.6rem;
    --result-pad: 32px;
    --result-minh: 6.2em;
    --result-maxw: 760px;

    --filters-maxw: 1120px;
  }

  html, body { height: 100%; -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
  body {
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto,
                 "Segoe UI Symbol", "Noto Music", "Apple Symbols", sans-serif;
    background: var(--bg); color: var(--text); padding: 24px;
  }
  h1 { font-size:1.6rem; font-weight:600; margin:0 0 8px; }
  h2 { font-size:1rem; font-weight:400; margin:0 0 16px; color:var(--muted); }
  .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  /* error banner */
  #err {
    display:none; margin:10px 0; padding:10px 12px; background:#3a1212; color:#ffd9d9;
    border:1px solid #b33; border-radius:10px; font-size:.95rem; white-space:pre-wrap;
  }
  #err.show { display:block; }

  /* Buttons */
  button {
    padding:12px 20px; border-radius:var(--radius); border:1px solid var(--accent);
    background:var(--card-bg); color:var(--text); cursor:pointer; font-size:1.1rem;
    transition:background .2s;
  }
  button:hover { background:var(--border); }
  button.primary { background:var(--accent); color:#000; font-weight:700; }
  button.primary:hover { background:var(--accent-hover); color:#111; }

  /* Result box */
  .result {
    margin-top:20px; padding: var(--result-pad); font-size: var(--result-font); font-weight:600;
    background:var(--card-bg); border:2px solid var(--accent); border-radius:var(--radius);
    min-height: var(--result-minh); width: min(100%, var(--result-maxw)); margin-inline: auto; box-sizing: border-box;
    display:flex; flex-direction:column; justify-content:center; align-items:center;
    text-align:center; line-height:1.4; box-shadow:0 0 12px rgba(255,255,255,.15);
  }
  .result .line { display:block; width:100%; text-align:center; line-height:1.35; }
  .result .line.fit  { white-space: nowrap; overflow: hidden; text-overflow: clip; }
  .result .line.ellip{ white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .result .meta  { color: #888; font-weight: normal; font-size: 0.9em; }
  .result .label { color: #bbb; font-weight: normal; }

  /* Filters panel (container) */
  .filters {
    margin-top: 12px;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px;
    width: min(100%, var(--filters-maxw));
    margin-inline: auto;
    box-sizing: border-box;
  }
  .filters.hidden { display: none; }

  .filters-top {
    display: flex; gap: 8px; align-items: center; justify-content: flex-end;
    margin-bottom: 8px;
  }

  /* Columns wrapper -> FLEX (no overlap possible) */
  .filters-inner {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }

  /* Column blocks */
  .filters-col {
    display: flex;
    flex-direction: column;
    gap: 8px;
    box-sizing: border-box;
    min-width: 0; /* let content shrink within */
  }
  .filters-col header {
    display: flex; align-items: center; justify-content: space-between;
  }
  .filters-col h3 { margin: 0; font-size: 1rem; font-weight: 600; }

  /* Column widths */
  .filters-col.strings { flex: 0 0 180px; }
  .filters-col.notes   { flex: 0 0 200px; }
  .filters-col.sizes   { flex: 0 0 160px; }
  .filters-col.scales  { flex: 1 1 420px; min-width: 380px; } /* elastic column */

  .mini-btns button { font-size: .8rem; padding: 4px 10px; border-radius: 999px;
    border: 1px solid var(--border); background: #1b1b1b; color: var(--text); }

  /* Checklists: page scrolls, no inner scrollbars */
  .checklist { display: grid; grid-template-columns: 1fr; gap: 6px; }
  .checklist label {
    display: flex; align-items: center; gap: 8px; padding: 6px 8px;
    border: 1px solid var(--border); border-radius: 8px; background: #161616; cursor: pointer;
    min-width: 0; overflow: hidden; /* keep inside its column */
  }
  .checklist input { transform: scale(1.1); }
  .checklist label > span:first-of-type {
    flex: 1; min-width: 0; white-space: normal; /* wrap main text as needed */
  }
  .checklist .muted { color: var(--muted); font-size: .85rem; margin-left: auto; white-space: nowrap; }

  /* Sizes: single column of full-width pills */
  .pills { display: grid; grid-template-columns: 1fr; gap: 8px; }
  .pill {
    display: inline-flex; justify-content: center; align-items: center; gap: 6px;
    border: 1px solid var(--border); background: #161616; color: var(--text);
    border-radius: 999px; padding: 8px 12px; cursor: pointer; user-select: none;
    font-size: 0.95rem; width: 100%; box-sizing: border-box;
  }
  .pill input { display: none; }
  .pill.active { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent) inset; }

  /* Responsive tweaks */
  @media (max-width: 1100px) {
    .filters-col.scales { min-width: min(100%, 520px); flex: 1 1 520px; }
  }
  @media (max-width: 600px) {
    .filters-col.strings,
    .filters-col.notes,
    .filters-col.sizes,
    .filters-col.scales { flex: 1 1 100%; min-width: 0; }
  }

  @media (max-width: 600px) and (orientation: portrait) {
    :root { --result-font: clamp(1.2rem, 4.5vw, 1.5rem); --result-pad: 22px; --result-minh: 6.0em; }
    body { padding: 18px; }
    h1 { font-size: 1.45rem; } h2 { font-size: .95rem; }
    .result .line.ellip { white-space: normal; overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; line-clamp: 2; }
  }
  @media (max-width: 380px) and (orientation: portrait) { .result .label { display:none; } }
  @media (max-height: 420px) and (orientation: landscape) {
    :root { --result-font: clamp(1rem, 4.2svh, 1.25rem); --result-pad: clamp(12px, 3.5svh, 18px); --result-minh: 5.6em; --result-maxw: 92svw; }
    body { padding: min(16px, 3svh); }
    h1 { font-size: clamp(1.1rem, 3.8svh, 1.3rem); } h2 { font-size: clamp(.85rem, 3.2svh, .95rem); }
    .result { box-shadow:0 0 8px rgba(255,255,255,.12); }
  }
</style>

<h1>The Rolodex From Hades [Demo Version]</h1>
<h2>A systematic and gamified approach to learning to improvise with intervallic patterns inspired by musical visionaries, including Nicolas Slonimsky, Allan Holdsworth and Wayne Krantz.</h2>

<div class="row">
  <button id="pickBtn" class="primary"><b>Generate</b></button>
</div>

<div id="err"></div>

<!-- Result first -->
<div id="out" class="result">—</div>

<!-- Filters toggle + panel UNDER the result -->
<div class="row" style="margin-top:12px">
  <button id="filtersBtn">Filters</button>
</div>

<div id="filters" class="filters hidden">
  <div class="filters-top">
    <button id="resetBtn" type="button" title="Reset all filters to default">Reset All</button>
  </div>

  <div class="filters-inner">
    <div class="filters-col strings">
      <header>
        <h3>Strings</h3>
        <div class="mini-btns">
          <button class="group-toggle" data-group="strings" type="button">All</button>
        </div>
      </header>
      <div id="stringsList" class="checklist"></div>
    </div>

    <div class="filters-col notes">
      <header>
        <h3>Notes</h3>
        <div class="mini-btns">
          <button class="group-toggle" data-group="notes" type="button">All</button>
        </div>
      </header>
      <div id="notesList" class="checklist"></div>
    </div>

    <div class="filters-col sizes">
      <header>
        <h3>Sizes</h3>
        <div class="mini-btns">
          <button class="group-toggle" data-group="sizes" type="button">All</button>
        </div>
      </header>
      <div id="sizesList" class="pills"></div>
    </div>

    <div class="filters-col scales">
      <header>
        <h3>Scales</h3>
        <div class="mini-btns">
          <button class="group-toggle" data-group="scales" type="button">All</button>
        </div>
      </header>
      <div id="scalesList" class="checklist"></div>
    </div>
  </div>
</div>

<script>
/* --- on-page error banner --- */
(function(){
  function showErr(msg){ var el=document.getElementById('err'); if(!el) return;
    el.textContent = 'Error: ' + msg; el.className='show'; }
  window.addEventListener('error', function(e){ showErr(e.message || 'Unknown error'); });
  window.addEventListener('unhandledrejection', function(e){ showErr((e.reason&&e.reason.message)||String(e.reason)); });
})();

function $(id){ return document.getElementById(id); }

/* --- Embedded Scales --- */
var EMBEDDED_SCALES = [
  {"id":"393","size":"5-note","name":"Pentatonic Major","intervals":"1-2-3-5-6"},
  {"id":"849","size":"6-note","name":"Messiaen Mode 1 (Whole Tone)","intervals":"1-2-3-#4-#5-b7"},
  {"id":"936","size":"6-note","name":"Blues","intervals":"1-b3-4-b5-nat5-b7"},
  {"id":"1324","size":"7-note","name":"Harmonic Minor","intervals":"1-2-b3-4-5-b6-7"},
  {"id":"1326","size":"7-note","name":"Melodic Minor","intervals":"1-2-b3-4-5-6-7"},
  {"id":"1334","size":"7-note","name":"Hungarian Minor","intervals":"1-2-b3-#4-5-b6-7"},
  {"id":"1359","size":"7-note","name":"Harmonic Major","intervals":"1-2-3-4-5-b6-7"},
  {"id":"1361","size":"7-note","name":"Major","intervals":"1-2-3-4-5-6-7"},
  {"id":"1594","size":"8-note","name":"Messiaen Mode 4","intervals":"1-b2-2-nat4-#4-nat5-#5-7"},
  {"id":"1636","size":"8-note","name":"Messiaen Mode 2 (Diminished)","intervals":"1-b2-b3-nat3-#4-5-6-b7"},
  {"id":"1736","size":"8-note","name":"Jazz Minor (add #4)","intervals":"1-2-b3-nat4-#4-5-6-7"},
  {"id":"1743","size":"8-note","name":"Jazz Minor (add b6)","intervals":"1-2-b3-4-nat5-#5-6-7"},
  {"id":"1745","size":"8-note","name":"Jazz Minor (add b7)","intervals":"1-2-b3-4-5-6-b7-nat7"},
  {"id":"1761","size":"8-note","name":"Messiaen Mode 6","intervals":"1-2-3-nat4-#4-#5-b7-nat7"},
  {"id":"1764","size":"8-note","name":"Jazz Major (add b6)","intervals":"1-2-3-4-nat5-#5-6-7"},
  {"id":"1766","size":"8-note","name":"Jazz Dominant (add nat7)","intervals":"1-2-3-4-5-6-b7-nat7"},
  {"id":"1948","size":"9-note","name":"Jazz Major (add b3, b6)","intervals":"1-2-b3-nat3-4-nat5-#5-6-7"},
  {"id":"1950","size":"9-note","name":"Jazz Dominant (add b3, nat7)","intervals":"1-2-b3-nat3-4-5-6-b7-nat7"},
  {"id":"1954","size":"9-note","name":"Messiaen Mode 3","intervals":"1-2-b3-nat3-#4-nat5-#5-b7-nat7"},
  {"id":"1961","size":"9-note","name":"Jazz Minor (add b5, b7)","intervals":"1-2-b3-nat4-#4-5-6-b7-nat7"},
  {"id":"2004","size":"10-note","name":"Messiaen Mode 7","intervals":"1-b2-nat2-b3-nat4-#4-5-#5-6-7"},
  {"id":"2048","size":"12-note","name":"Chromatic","intervals":"1-b2-nat2-b3-nat3-nat4-#4-nat5-#5-6-b7-nat7"}
];

/* Accidental converter */
function toMusical(str){
  if (!str) return str;
  return String(str)
    .replace(/([A-Ga-g])##/g, '$1𝄪').replace(/([A-Ga-g])bb/g, '$1𝄫')
    .replace(/([A-Ga-g])#/g,  '$1♯').replace(/([A-Ga-g])b/g,  '$1♭')
    .replace(/##(?=\d)/g, '𝄪').replace(/bb(?=\d)/g, '𝄫')
    .replace(/#(?=\d)/g,  '♯').replace(/b(?=\d)/g,  '♭')
    .replace(/\bnat\s*(\d)/gi, '♮$1');
}

/* Base pools */
var BASE_STRINGS = ["6","5","4","3","2","1"];
var BASE_NOTES   = ["A","A#/Bb","B","C","C#/Db","D","D#/Eb","E","F","F#/Gb","G","G#/Ab"];

/* Derive Sizes from scales — numerically sorted by leading number */
var BASE_SIZES = (function(){
  var map = {}, arr, i;
  for (i=0;i<EMBEDDED_SCALES.length;i++) map[EMBEDDED_SCALES[i].size] = 1;
  arr = Object.keys(map);
  arr.sort(function(a,b){
    var mA = a.match(/^(\d+)/), mB = b.match(/^(\d+)/);
    var nA = mA ? parseInt(mA[1],10) : 1e9;
    var nB = mB ? parseInt(mB[1],10) : 1e9;
    if (nA !== nB) return nA - nB;
    return a < b ? -1 : a > b ? 1 : 0;
  });
  return arr;
})();

/* Persistence */
var STORE_KEY = "rolodex_filters_v8";
function loadSelection(){
  try { var raw = localStorage.getItem(STORE_KEY); return raw ? JSON.parse(raw) : null; }
  catch (e) { return null; }
}
function safeSaveSelection(sel){
  try { localStorage.setItem(STORE_KEY, JSON.stringify(sel)); } catch (e) { /* ignore */ }
}

/* Selection sets */
function makeDefaultSelection(){
  var ids = EMBEDDED_SCALES.map(function(s){ return s.id; });
  return {
    strings: new Set(BASE_STRINGS),
    notes:   new Set(BASE_NOTES),
    sizes:   new Set(BASE_SIZES),
    scales:  new Set(ids)
  };
}
var savedSel = loadSelection();
var selected = savedSel ? {
  strings: new Set(savedSel.strings || BASE_STRINGS),
  notes:   new Set(savedSel.notes   || BASE_NOTES),
  sizes:   new Set(savedSel.sizes   || BASE_SIZES),
  scales:  new Set(savedSel.scales  || EMBEDDED_SCALES.map(function(s){return s.id;}))
} : makeDefaultSelection();

/* Helpers */
function checkboxRow(id, labelHTML, checked, extraRightHTML){
  return '<label>' +
           '<input type="checkbox" data-id="' + id + '" ' + (checked ? 'checked' : '') + '>' +
           '<span>' + labelHTML + '</span>' +
           (extraRightHTML ? '<span class="muted">' + extraRightHTML + '</span>' : '') +
         '</label>';
}
function saveAll(){
  safeSaveSelection({
    strings: Array.from(selected.strings),
    notes:   Array.from(selected.notes),
    sizes:   Array.from(selected.sizes),
    scales:  Array.from(selected.scales)
  });
}

/* Toggle helpers */
function groupTotals(group){
  if (group === 'strings') return BASE_STRINGS.length;
  if (group === 'notes')   return BASE_NOTES.length;
  if (group === 'sizes')   return BASE_SIZES.length;
  if (group === 'scales')  return EMBEDDED_SCALES.length;
  return 0;
}
function isAllSelected(group){
  var set = selected[group];
  var total = groupTotals(group);
  return set && set.size === total;
}
function updateGroupToggleLabels(){
  var btns = document.querySelectorAll('.group-toggle');
  for (var i=0;i<btns.length;i++){
    var b = btns[i];
    var grp = b.getAttribute('data-group');
    b.textContent = isAllSelected(grp) ? 'None' : 'All';
  }
}

/* Render Filters */
function renderFilters(){
  var stringsList = $("stringsList");
  var notesList   = $("notesList");
  var sizesList   = $("sizesList");
  var scalesList  = $("scalesList");
  if (!stringsList || !notesList || !sizesList || !scalesList) return;

  stringsList.innerHTML = BASE_STRINGS.map(function(s){
    return checkboxRow(s, s, selected.strings.has(s));
  }).join("");

  notesList.innerHTML = BASE_NOTES.map(function(n){
    return checkboxRow(n, toMusical(n), selected.notes.has(n));
  }).join("");

  sizesList.innerHTML = BASE_SIZES.map(function(sz){
    var on = selected.sizes.has(sz);
    return '<label class="pill' + (on ? ' active' : '') + '">' +
             '<input type="checkbox" data-id="' + sz + '" ' + (on?'checked':'') + '>' +
             '<span>' + sz + '</span>' +
           '</label>';
  }).join("");

  scalesList.innerHTML = EMBEDDED_SCALES.map(function(s){
    return checkboxRow(s.id, toMusical(s.name), selected.scales.has(s.id), 'ID: ' + s.id);
  }).join("");

  /* change handlers */
  stringsList.onchange = function(e){
    var t = e.target || e.srcElement;
    if (t && t.matches && t.matches('input[type="checkbox"]')) {
      var id = t.getAttribute("data-id");
      if (t.checked) selected.strings.add(id); else selected.strings.delete(id);
      saveAll(); updateGroupToggleLabels();
    }
  };
  notesList.onchange = function(e){
    var t = e.target || e.srcElement;
    if (t && t.matches && t.matches('input[type="checkbox"]')) {
      var id = t.getAttribute("data-id");
      if (t.checked) selected.notes.add(id); else selected.notes.delete(id);
      saveAll(); updateGroupToggleLabels();
    }
  };
  scalesList.onchange = function(e){
    var t = e.target || e.srcElement;
    if (t && t.matches && t.matches('input[type="checkbox"]')) {
      var id = t.getAttribute("data-id");
      if (t.checked) selected.scales.add(id); else selected.scales.delete(id);
      saveAll(); updateGroupToggleLabels();
    }
  };

  /* Sizes pills toggle */
  sizesList.onclick = function(e){
    var el = e.target || e.srcElement;
    while (el && el !== sizesList && (!el.classList || !el.classList.contains('pill'))) {
      el = el.parentNode;
    }
    if (!el || el === sizesList) return;
    var input = el.querySelector('input[type="checkbox"]');
    if (!input) return;
    var id = input.getAttribute('data-id');
    var was = input.checked;
    input.checked = !was;
    if (input.checked) { selected.sizes.add(id); el.classList.add('active'); }
    else { selected.sizes.delete(id); el.classList.remove('active'); }
    saveAll(); updateGroupToggleLabels();
  };

  /* Consolidated All/None toggles */
  var toggles = document.querySelectorAll('.group-toggle');
  for (var i=0;i<toggles.length;i++){
    toggles[i].onclick = function(){
      var grp = this.getAttribute('data-group');
      var set = selected[grp];
      if (!set) return;
      var all = isAllSelected(grp);  /* check BEFORE mutating */
      set.clear();
      if (!all) {
        if (grp === 'strings') BASE_STRINGS.forEach(function(v){ set.add(v); });
        else if (grp === 'notes') BASE_NOTES.forEach(function(v){ set.add(v); });
        else if (grp === 'sizes') BASE_SIZES.forEach(function(v){ set.add(v); });
        else if (grp === 'scales') EMBEDDED_SCALES.forEach(function(s){ set.add(s.id); });
      }
      saveAll();
      renderFilters(); /* refresh lists and button labels */
    };
  }

  updateGroupToggleLabels();
}

/* Fit only the first line (.fit) */
function fitLines(){
  var out = $("out");
  if (!out) return;
  var baseSize = parseFloat(getComputedStyle(out).fontSize) || 24;
  var minSize = 12;
  var lines = out.querySelectorAll('.line.fit');
  for (var i=0; i<lines.length; i++){
    var line = lines[i];
    line.style.fontSize = "";
    var currentSize = parseFloat(getComputedStyle(line).fontSize) || baseSize;
    var maxWidth = out.clientWidth - 6;
    if (line.scrollWidth > maxWidth) {
      var ratio = maxWidth / line.scrollWidth;
      var newSize = Math.max(minSize, currentSize * ratio);
      line.style.fontSize = newSize + "px";
    }
  }
}

/* Picker (uses filters, including sizes) */
function pick(){
  try {
    var stringsPool = BASE_STRINGS.filter(function(s){ return selected.strings.has(s); });
    var notesPool   = BASE_NOTES.filter(function(n){ return selected.notes.has(n); });
    var scalesPool  = EMBEDDED_SCALES.filter(function(s){
      return selected.scales.has(s.id) && selected.sizes.has(s.size);
    });

    if (!stringsPool.length && !notesPool.length && !scalesPool.length) {
      $("out").innerHTML = '<div class="line">No items selected.</div>';
      return;
    }

    var stringVal = stringsPool.length ? stringsPool[Math.floor(Math.random()*stringsPool.length)] : null;
    var noteVal   = notesPool.length   ? notesPool[Math.floor(Math.random()*notesPool.length)]     : null;
    var s         = scalesPool.length  ? scalesPool[Math.floor(Math.random()*scalesPool.length)]   : null;

    var lines = [];
    if (stringVal || noteVal) {
      var noteStr = toMusical(noteVal);
      lines.push(
        '<div class="line fit"><span class="label">String:</span> ' + (stringVal!=null?stringVal:'—') +
        ' · <span class="label">Note:</span> ' + (noteStr!=null?noteStr:'—') + '</div>'
      );
    }
    if (s) {
      var nameStr = toMusical(s.name);
      var ivlStr  = toMusical(s.intervals);
      lines.push('<div class="line ellip"><span class="label">Scale:</span> ' + nameStr +
                 ' <span class="meta">(ID: ' + s.id + ', Size: ' + s.size + ')</span></div>');
      lines.push('<div class="line ellip"><span class="label">Intervals:</span> ' + ivlStr + '</div>');
    } else {
      lines.push('<div class="line ellip"><span class="label">Scale:</span> —</div>');
      lines.push('<div class="line ellip"><span class="label">Intervals:</span> —</div>');
    }

    $("out").innerHTML = lines.join("");
    fitLines();
  } catch (e) {
    var el=document.getElementById('err'); if(el){ el.textContent='Error: '+e.message; el.className='show'; }
  }
}

/* Wire up */
var pickBtn = $("pickBtn");
if (pickBtn) pickBtn.addEventListener("click", pick);

document.addEventListener("keydown", function(e){
  var tag = (e.target && e.target.tagName) ? e.target.tagName : "";
  if ((e.code === "Space" || e.key === " ") && !/INPUT|TEXTAREA/.test(tag)) { e.preventDefault(); pick(); }
});

var filtersBtn = $("filtersBtn");
if (filtersBtn) filtersBtn.addEventListener("click", function(){
  var panel = $("filters");
  if (panel) panel.classList.toggle("hidden");
});

/* Reset All filters */
var resetBtn = $("resetBtn");
if (resetBtn) resetBtn.addEventListener("click", function(){
  selected = makeDefaultSelection();
  saveAll();
  renderFilters();
});

/* Build filters on load */
renderFilters();

/* Refit on resize / rotate */
window.addEventListener("resize", fitLines);
window.addEventListener("orientationchange", function(){ setTimeout(fitLines, 50); });
</script>
